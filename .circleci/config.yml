version: 2
jobs:
  build:
    parallelism: 2
    working_directory: ~/src
    docker:
      - image: docker:17.06.0-ce
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - run:
          name: Dependencies
          command: apk add --no-cache curl git jq make openssh
      - run:
          name: Artifactory Login
          command: echo ${ARTIFACTORY_PASSWORD} | docker login -u ${ARTIFACTORY_USERNAME} --password-stdin upsidetravel-docker.jfrog.io
      - checkout
      - run:
         name: greenkeeper
         command: |
            case $CIRCLE_NODE_INDEX in
              0) if [[ `echo $CIRCLE_BRANCH | grep -E "^greenkeeper.*$"` ]]; then
                   make greenkeeper
                 fi
              ;;
            esac
      - run:
          name: Build and Test
          command: |
            case $CIRCLE_NODE_INDEX in
              0) make image runtests
              ;;
              1) make snyk
              ;;
            esac
      - deploy:
          command: |
            if [ -z "${CIRCLE_NO_DEPLOY}" ]; then
              if [[ `echo $CIRCLE_BRANCH | grep -E "^(master|hotfix)$"` ]]; then 
                make push
              fi
              if [[ `echo $CIRCLE_BRANCH | grep -E "^(master)$"` ]]; then 
                make deploy
              fi
            fi
